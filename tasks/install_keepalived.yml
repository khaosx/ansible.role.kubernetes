---

- name: Install keepalived
  ansible.builtin.apt:
    name: keepalived
    state: present
    update_cache: true

- name: Allow VRRP protocol in UFW
  ansible.builtin.command: ufw allow proto vrrp from any to any
  register: __kubernetes_ufw_vrrp
  changed_when: "'Rule added' in __kubernetes_ufw_vrrp.stdout or 'Rules updated' in __kubernetes_ufw_vrrp.stdout"
  failed_when: false

- name: Get network interface name from default route
  ansible.builtin.shell: |
    set -o pipefail
    ip route show default | grep -oP 'dev \K\S+' | head -1
  register: __kubernetes_detected_interface
  changed_when: false
  args:
    executable: /bin/bash

- name: Set interface fact
  ansible.builtin.set_fact:
    __kubernetes_vip_interface: "{{ __kubernetes_detected_interface.stdout }}"

- name: Determine keepalived priority based on node
  ansible.builtin.set_fact:
    __kubernetes_keepalived_priority: "{{ 101 - groups['kubernetes_control_plane'].index(inventory_hostname) }}"
    __kubernetes_keepalived_state: "{{ 'MASTER' if inventory_hostname == kubernetes_primary_control_plane else 'BACKUP' }}"

- name: Create keepalived health check script
  ansible.builtin.copy:
    dest: /etc/keepalived/check_apiserver.sh
    mode: "0755"
    content: |
      #!/bin/bash
      # Check if kube-apiserver is responding
      curl -sfk https://127.0.0.1:6443/healthz -o /dev/null
      exit $?

- name: Configure keepalived
  ansible.builtin.copy:
    dest: /etc/keepalived/keepalived.conf
    mode: "0644"
    content: |
      global_defs {
        enable_script_security
        script_user root
      }

      vrrp_script check_apiserver {
        script "/etc/keepalived/check_apiserver.sh"
        interval 3
        weight -2
        fall 10
        rise 2
      }

      vrrp_instance VI_1 {
        state {{ __kubernetes_keepalived_state }}
        interface {{ __kubernetes_vip_interface }}
        virtual_router_id 51
        priority {{ __kubernetes_keepalived_priority }}
        advert_int 1

        authentication {
          auth_type PASS
          auth_pass {{ kubernetes_keepalived_password }}
        }

        virtual_ipaddress {
          {{ kubernetes_control_plane_vip }}/32
        }

        track_script {
          check_apiserver
        }
      }
  no_log: true
  notify: Kubernetes | Restart keepalived

- name: Enable and start keepalived
  ansible.builtin.systemd:
    name: keepalived
    enabled: true
    state: started
    daemon_reload: true

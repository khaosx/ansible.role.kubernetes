---

- name: Check if Cilium CLI is installed
  ansible.builtin.command: which cilium
  register: cilium_cli_check
  changed_when: false
  failed_when: false

- name: Get system architecture
  ansible.builtin.set_fact:
    cilium_arch: "{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}"

- name: Download Cilium CLI
  ansible.builtin.get_url:
    url: "https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-{{ cilium_arch }}.tar.gz"
    dest: /tmp/cilium-cli.tar.gz
    mode: "0644"
  when: cilium_cli_check.rc != 0

- name: Extract Cilium CLI
  ansible.builtin.unarchive:
    src: /tmp/cilium-cli.tar.gz
    dest: /usr/local/bin
    remote_src: true
  when: cilium_cli_check.rc != 0

- name: Check if Cilium is already installed in cluster
  ansible.builtin.command: >
    kubectl get deployment cilium-operator -n kube-system
    --kubeconfig /etc/kubernetes/admin.conf
  register: cilium_deployment
  changed_when: false
  failed_when: false

- name: Install Cilium CNI
  ansible.builtin.command: >
    cilium install
    --version {{ kubernetes_cilium_version }}
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: cilium_deployment.rc != 0

- name: Wait for Cilium to be ready
  ansible.builtin.command: cilium status --wait
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  changed_when: false
  retries: 12
  delay: 10
  register: cilium_ready
  until: cilium_ready.rc == 0

---
# defaults/main.yml â€” kubernetes
# Defaults for Kubernetes cluster deployment via kubeadm

# Kubernetes version
kubernetes_version: "1.32"
kubernetes_apt_version: "1.32.*"

# Cluster settings
kubernetes_cluster_name: "k8s-clst-01"
kubernetes_pod_network_cidr: "10.244.0.0/16"
kubernetes_service_cidr: "10.96.0.0/12"

# Control plane endpoint (VIP for HA)
kubernetes_control_plane_endpoint: "10.0.20.246:6443"
kubernetes_control_plane_vip: "10.0.20.246"

# Keepalived settings for VIP failover
kubernetes_keepalived_password: "{{ vault_kubernetes_keepalived_password }}"

# CNI plugin: cilium, calico, or flannel
kubernetes_cni: "cilium"
kubernetes_cilium_version: "1.17.0"

# MetalLB load balancer
kubernetes_metallb_enabled: true
kubernetes_metallb_version: "0.14.9"
kubernetes_metallb_address_range: "10.0.20.30-10.0.20.39"

# Traefik ingress controller
kubernetes_traefik_enabled: true
kubernetes_traefik_version: "34.3.0"
kubernetes_traefik_loadbalancer_ip: "10.0.20.30"
kubernetes_cluster_domain: "khaosx.io"
kubernetes_traefik_dashboard_host: "traefik.{{ kubernetes_cluster_domain }}"
kubernetes_traefik_dashboard_tls_secret_name: "traefik-dashboard-tls"
kubernetes_traefik_dashboard_tls_enabled: true

# cert-manager
kubernetes_cert_manager_enabled: true
kubernetes_cert_manager_version: "1.17.1"
kubernetes_cert_manager_email: "{{ vault_configure_ssl_email }}"
kubernetes_cert_manager_cloudflare_api_token: "{{ vault_configure_ssl_cloudflare_api_token }}"
kubernetes_cert_manager_dns_zone: "{{ vault_site_domain }}"
kubernetes_traefik_dashboard_certificate_enabled: true
kubernetes_traefik_dashboard_certificate_issuer: "letsencrypt-prod"

# NFS CSI driver
kubernetes_nfs_enabled: true
kubernetes_nfs_csi_version: "v4.10.0"

# Ceph CSI storage
kubernetes_ceph_enabled: true
kubernetes_ceph_cluster_id: "7ecb9951-45cd-4825-af85-d70faea45ea6"
kubernetes_ceph_monitors:
  - "10.0.30.101:6789"
  - "10.0.30.102:6789"
  - "10.0.30.103:6789"
kubernetes_ceph_rbd_pool: "rbd_data"
kubernetes_ceph_user: "kubernetes"
kubernetes_ceph_user_key: "{{ vault_kubernetes_ceph_user_key }}"
kubernetes_ceph_default_storage_class: true

# Containerd settings
kubernetes_containerd_version: "1.7.*"

# First control plane node (used for init)
kubernetes_primary_control_plane: "ctrl-01"

# Node roles (set in inventory or host_vars)
# kubernetes_role: control_plane | worker

# kubeadm token settings
kubernetes_token_ttl: "24h"

# UFW profiles
kubernetes_ufw_profiles_catalog:
  - name: Kubernetes-Control-Plane
    title: "Kubernetes Control Plane"
    description: "API server, etcd, scheduler, controller"
    ports:
      - "6443/tcp"
      - "2379:2380/tcp"
      - "10250/tcp"
      - "10259/tcp"
      - "10257/tcp"
  - name: Kubernetes-Worker
    title: "Kubernetes Worker"
    description: "Kubelet and NodePort services"
    ports:
      - "10250/tcp"
      - "10256/tcp"
      - "30000:32767/tcp"
  - name: Kubernetes-CNI
    title: "Kubernetes CNI"
    description: "CNI overlay network (VXLAN/Geneve)"
    ports:
      - "8472/udp"
      - "4240/tcp"
      - "4244/tcp"
kubernetes_ufw_allow_control_plane:
  - Kubernetes-Control-Plane
  - Kubernetes-CNI

kubernetes_ufw_allow_worker:
  - Kubernetes-Worker
  - Kubernetes-CNI

# Kernel modules required for Kubernetes
kubernetes_kernel_modules:
  - overlay
  - br_netfilter

# Sysctl settings for Kubernetes networking
kubernetes_sysctl_settings:
  net.bridge.bridge-nf-call-iptables: 1
  net.bridge.bridge-nf-call-ip6tables: 1
  net.ipv4.ip_forward: 1
